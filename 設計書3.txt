**四国SNS飲食店マップ
最終設計書（MVP → 安定後拡張の二段階構成・geohash対応 完全版）**

1. 本書の位置づけ
本書は、Webアプリケーション「四国SNS飲食店マップ」の
初期MVP（Phase 1）と、運用安定後の拡張フェーズ（Phase 2）を明確に分離した最終設計書である。

目的は以下の通り。

MVPを最速でリリースし、無料枠内で安定稼働させる

運用データを見ながら、必要な機能だけを段階的に追加する

個人開発での副収入獲得を現実的に達成する

過剰実装・過剰運用を避ける

後方互換性を維持するため、Phase 1 から geohash を導入する

無料枠強制・規約リスク回避などの防衛策は「後から追加」できる構造にする

2. サービス定義（共通）
SNS投稿を起点に、四国の飲食店・観光スポットを地図上に可視化する

評価しない・判断しない

投稿数（postCount）だけを表示する

収益は宿泊・レンタカーのアフィリエイト

3. 二段階構成の全体像
フェーズ	目的	実装範囲	運用負荷
Phase 1（MVP）	最速リリース・無料枠安定稼働	最小限の機能のみ	1日10〜15分
Phase 2（安定後）	収益最大化・防衛策強化	高度機能を段階追加	1日30分以内
4. Phase 1（MVP）— 初期実装の構想
4.1 技術構成（MVP版）
Cloudflare Pages（推奨）  
→ Vercel規約違反リスクを避ける

Next.js（App Router）

Firebase Firestore（素直にクエリ）

Google Maps JavaScript API（遅延読み込みのみ）

Static Maps API（スポット詳細）

YouTube Data API（PlaylistItemsのみ）

Gemini API（最低限の場所特定）

4.2 データ設計（MVP版・geohash導入済）
stores（Phase 1 から geohash を必須フィールドとして導入）
ts
{
  placeId: string,
  name: string,
  lat: number,
  lng: number,
  geohash: string,   // ← Phase 1 から必須（後方互換性のため）
  region: "shikoku",
  prefecture: "kagawa" | "ehime" | "kochi" | "tokushima",
  category: "gourmet" | "tourism" | "onsen" | "spot",
  subCategory?: string,
  postCount: number,
  createdAt: Timestamp,
  updatedAt: Timestamp,

  affiliateLinks: {
    hotelSearchUrl?: string,
    rentacarUrl?: string,
    manualHotelUrl?: string // Phase 2 で使用
  },

  lastScrapedAt: Timestamp,
  isAutoGenerated: boolean
}
posts
ts
{
  storeId: string,
  platform: "youtube",
  url: string,
  title?: string,
  text?: string,
  status: "auto" | "pending" | "rejected",
  createdAt: Timestamp
}
※ Phase 1 は YouTube のみ。

4.3 SNS対応（MVP版）
YouTubeのみ対応

PlaylistItems API で新着動画を取得（クォータ1/100の節約）

Instagram / TikTok / X は一切触らない

4.4 地図UI（MVP版）
遅延読み込み

ピンサイズ差のみ

Static Maps をスポット詳細に表示

429エラー時は「地図を表示できません」だけでOK（代替一覧はPhase 2）

4.5 収益化（MVP版）
hotelSearchUrl（自動生成）

rentacarUrl（自動生成）

manualHotelUrl（手動最適化）は Phase 2 まで封印

4.6 運用（MVP版）
AI確信度

80%以上 → auto

80%未満 → pending

pending の精査は 1日10分以内

収益導線の手動最適化は行わない

4.7 無料枠強制（MVP版）
Google Maps API の Quotas 設定

YouTube API の上限設定

Gemini API の上限設定

Firestoreのキャッシュ最適化は Phase 2 に回す。

5. Phase 2（運用安定後）— 機能追加フェーズ
Phase 1 の運用が安定し、

月間1,000セッション

CTR 3%以上

運用が1日30分以内
を満たしたら、以下の機能を段階的に追加する。

5.1 SNS対応の拡張
Instagram（位置情報付き投稿のみ）

TikTok（ハッシュタグ限定）

X（地名＋店名の投稿のみ）

※スクレイピングは禁止。API利用可能な範囲で。

5.2 Firestore 読み取り最適化（本格導入）
Phase 1 で geohash を保存しているため、移行コストはゼロ。

Geohash による広域データ取得

React Query によるキャッシュ

マップ移動時の再フェッチ抑制

これにより、Firestoreの従量課金リスクを大幅に削減。

5.3 429エラー時の代替表示（UX強化）
「本日の地図表示上限に達しました」

代替として、テキスト形式の店舗一覧を表示

SEO・UX改善のための必須実装

5.4 手動アフィリエイト最適化（収益最大化）
manualHotelUrl を追加

人気スポットに対して「おすすめ宿」を手動で設定

CTR向上を狙う

5.5 防衛的実装の強化
API障害時のフォールバック

SNS APIの仕様変更に備えた抽象化

AI誤判定の自動検知ロジック

5.6 運用フロー（Phase 2）
pending精査：15分

manualHotelUrl最適化：10分

データクリーニング：5分

合計：1日30分以内

6. 撤退・凍結基準（共通）
Google Maps API 請求額が 0ドルでない

月間1,000セッション未達

CTR 3%未達

運用が1日30分を超える

7. 最終宣言
本設計書は、
「最速でリリースするMVP」 と
「安定後に収益最大化するPhase 2」  
を明確に分離し、さらに

geohash を Phase 1 から導入

後方互換性を完全に確保

無料枠強制

SNS拡張の余地

Firestore最適化の布石

をすべて盛り込んだ 完全版の最終設計書 である。